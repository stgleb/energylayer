<head>
    <script src="https://code.jquery.com/jquery-1.12.3.js"
            integrity="sha256-1XMpEtA4eKXNNpXcJ1pmMPs8JV+nwLdEqwiJeCQEkyc="
            crossorigin="anonymous"></script>
    <title>Energylayer Dashboard </title>

    <script src="{{ url_for('static', filename='js/graphs/plugins/flot/jquery.flot.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/graphs/plugins/flot/jquery.flot.time.js') }}"></script>
    <script src="{{ url_for('static', filename='js/graphs/plugins/flot/jquery.flot.axislabels.js') }}"></script>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/chart.css') }}">

    <!-- Bootstrap -->
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

    <link href="{{ url_for('static', filename='dashboard/css/bootstrap.min.css') }}" rel="stylesheet">
    <!-- <link href="fonts/css/font-awesome.min.css" rel="stylesheet">  -->
    <link href="{{ url_for('static', filename='dashboard/css/animate.min.css') }}" rel="stylesheet">
    <!-- Custom styling plus plugins -->
    <link href="{{ url_for('static', filename='dashboard/css/custom.css') }}" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='dashboard/css/maps/jquery-jvectormap-2.0.3.css') }}" />
    <link href="{{ url_for('static', filename='dashboard/css/icheck/flat/green.css') }}" rel="stylesheet" />
    <link href="{{ url_for('static', filename='dashboard/css/floatexamples.css') }}" rel="stylesheet" type="text/css" />

    <!-- <script src="js/nprogress.js"></script>  -->

    <!--[if lt IE 9]>
        <script src="{{ url_for('static', filename='dashboard/js/ie8-responsive-file-warning.js') }}"></script>
</head>
<!-- HTML -->
<!-- Main Layout Stylesheet -->
<body class="nav-md">
<div class="container body">


    <div class="main_container">

        <div class="col-md-3 left_col">
            <div class="left_col scroll-view">

                <div class="navbar nav_title" style="border: 0;">
                    <!-- <a href="../index.html" class="site_title"><i class="fa fa-paw">k</i> <span>Energylayer</span></a>  -->
						<!-- <a href="../index.html" class="site_title"><img src="../img/small_logo.png" alt="logo" class="small_logo"><span> Energylayer</span></a> -->
			            <div class="small_logo"><a href="{{ url_for('index') }}"><img src="{{ url_for('static', filename='img/big_logo.png') }}" alt="logo"> </a>   </div>
                    </div>
                    <div class="clearfix"></div>

                    <!-- menu prile quick info -->

                    <!-- /menu prile quick info -->

                    <br />


                    <!-- sidebar menu
                   ================================================= -->
                    <div id="sidebar-menu" class="main_menu_side hidden-print main_menu">

                        <div class="menu_section">
                            <h3>General</h3>
                            <ul class="nav side-menu">
                                <li>
                                    <a href="{{ url_for('index') }}">
                                        <i class="fa fa-home"></i> Home <span class="fa fa-chevron-down"></span>
                                    </a>
                                    <ul class="nav child_menu" style="display: none">
                                        <li><a href="index.html">Generation Dashboard</a>
                                        </li>
                                        <li><a href="index.html">Consumption Dashboard</a>
                                        </li>
                                    </ul>
                                </li>
                                {% for metric in metrics %}
                                    <li>
                                        <a href="{{ url_for('dashboard') }}/{{ metric }}">
                                            <i class="fa fa-home"></i> {{ metric }} <span
                                                class="fa fa-chevron-down"></span>
                                        </a>
                                    </li>
                                {% endfor %}
                                {% if current_user.is_authenticated %}
                                <li><a href="{{ url_for('edit_user') }}"><i class="fa fa-table"></i> Profile <span class="fa fa-chevron-down"></span></a>
                                    <ul class="nav child_menu" style="display: none">
                                        <li><a href="tables.html">Tables</a>
                                        </li>
                                        <li><a href="tables_dynamic.html">Table Dynamic</a>
                                        </li>
                                    </ul>
                                </li>
                                {% endif %}
                                <li><a><i class="fa fa-bar-chart-o"></i> Data Presentation <span class="fa fa-chevron-down"></span></a>
                                    <ul class="nav child_menu" style="display: none">
                                        <li><a href="chartjs.html">Chart JS</a>
                                        </li>
                                        <li><a href="chartjs2.html">Chart JS2</a>
                                        </li>
                                        <li><a href="morisjs.html">Moris JS</a>
                                        </li>
                                        <li><a href="echarts.html">ECharts </a>
                                        </li>
                                        <li><a href="other_charts.html">Other Charts </a>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </div>

                    </div>
                    <!-- /sidebar menu -->

                    <!-- /menu footer buttons -->
                    <!-- /menu footer buttons -->
                </div>
            </div>

            <!-- top navigation
            ================================================= -->
            <div class="top_nav">

                <div class="nav_menu">
                    <nav class="" role="navigation">
                        <div class="nav toggle">
                            <a id="menu_toggle"><i class="fa fa-bars"></i></a>
                        </div>

                        <ul class="nav navbar-nav navbar-right">
                            <li class="">
                                <a href="javascript:;" class="user-profile dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                                    {% if not current_user.is_authenticated %}
                                        <img src="{{ url_for('static', filename='img/img.jpg') }}" alt="">John Doe
                                        <span class=" fa fa-angle-down"></span>
                                    {% else %}
                                        {{ current_user.first_name }}
                                        <img src="{{ current_user.avatar}}" width="40" height="40" class="avatar">
                                        <span class=" fa fa-angle-down"></span>
                                    {% endif %}
                                </a>
                                <ul class="dropdown-menu dropdown-usermenu animated fadeInDown pull-right">
                                    <li><a href="javascript:;">  Profile</a>
                                    </li>
                                    <li>
                                        <a href="javascript:;">
                                            <span class="badge bg-red pull-right">50%</span>
                                            <span>Settings</span>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="javascript:;">Help</a>
                                    </li>
                                    <li><a href="login.html"><i class="fa fa-sign-out pull-right"></i> Log Out</a>
                                    </li>
                                </ul>
                            </li>
                            <li role="presentation" class="dropdown">
                                <a href="javascript:;" class="dropdown-toggle info-number" data-toggle="dropdown" aria-expanded="false">
                                    <i class="fa fa-envelope-o"></i>
                                    <span class="badge bg-green">27</span>
                                </a>
                                <ul id="menu1" class="dropdown-menu list-unstyled msg_list animated fadeInDown" role="menu">
                                    <li>
                                        <a>
                                            <span class="image">
                                        <img src="{{ url_for('static', filename='img/img.jpg') }}" alt="Profile Image" />
                                    </span>
                                            <span>
                                        <span>John Smith</span>
                                            <span class="time">3 mins ago</span>
                                            </span>
                                            <span class="message">
                                        Film festivals used to be do-or-die moments for movie makers. They were where...
                                    </span>
                                        </a>
                                    </li>
                                    <li>
                                        <a>
                                            <span class="image">
                                        <img src="{{ url_for('static', filename='img/img.jpg') }}" alt="Profile Image" />
                                    </span>
                                            <span>
                                        <span>John Smith</span>
                                            <span class="time">3 mins ago</span>
                                            </span>
                                            <span class="message">
                                        Film festivals used to be do-or-die moments for movie makers. They were where...
                                    </span>
                                        </a>
                                    </li>
                                    <li>
                                        <a>
                                            <span class="image">
                                        <img src="{{ url_for('static', filename='img/img.jpg') }}" alt="Profile Image" />
                                    </span>
                                            <span>
                                        <span>John Smith</span>
                                            <span class="time">3 mins ago</span>
                                            </span>
                                            <span class="message">
                                        Film festivals used to be do-or-die moments for movie makers. They were where...
                                    </span>
                                        </a>
                                    </li>
                                    <li>
                                        <a>
                                            <span class="image">
                                        <img src="{{ url_for('static', filename='img/img.jpg') }}" alt="Profile Image" />
                                    </span>
                                            <span>
                                        <span>John Smith</span>
                                            <span class="time">3 mins ago</span>
                                            </span>
                                            <span class="message">
                                        Film festivals used to be do-or-die moments for movie makers. They were where...
                                    </span>
                                        </a>
                                    </li>
                                    <li>
                                        <div class="text-center">
                                            <a href="inbox.html">
                                                <strong>See All Alerts</strong>
                                                <i class="fa fa-angle-right"></i>
                                            </a>
                                        </div>
                                    </li>
                                </ul>
                            </li>

                        </ul>
                    </nav>
                </div>

            </div>
            <!-- /top navigation -->


            <!-- page content -->
            <div class="right_col" role="main">
                <table align="center">
                    {% for device in devices %}
                        <tr>
                            <span align="center"><h2>Device id: {{ device }}</h2></span>
                            <div id="dashboard-demo" class="tabbable analytics-tab paper-stack">
                                <div class="row">
                                    <div class="col-md-3"></div>
                                    <div class="col-md-9 offset2">
                                        <ul id="navs" class="nav nav-pills">
                                            <li class="active"><a href="#" data-target="#live" data-toggle="tab"><i
                                                    class="icon-history"></i> Live Stats</a>
                                            </li>
                                            <li><a href="#" data-target="#math" data-toggle="tab"><i class="icon-graph"></i> Hour</a>
                                            </li>
                                            <li id='second'><a href="#" data-target="#fb" data-toggle="tab"><i
                                                    class="icon-facebook"></i> Day</a></li>
                                            <li><a href="#" data-target="#revenue" data-toggle="tab"><i class="icon-bars"></i> Week</a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="tab-content">
                                    <div id="live" class="tab-pane active">
                                        <div class="analytics-tab-content">
                                            <div class="row">
                                                <div class="col-md-2"></div>
                                                <div class="col-md-9 offset2">
                                                    <!--div id="demo-chart-00" style="height: 265px;"></div -->
                                                    <div id="flot-placeholder{{ device }}"
                                                         style="width:691px;height:265px;margin:30"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </tr>
                    {% endfor %}
                </table>
                </div>

                <footer>
                    <div class="">
                        <p class="pull-right">Energylayer 2016.

                        </p>
                    </div>
                    <div class="clearfix"></div>
                </footer>
                <!-- /footer content -->
            </div>
            <!-- /page content -->
        </div>
</body>

<script>
    var user_id = 0;
    {% if current_user.is_authenticated %}
        user_id = {{ current_user.id }};
    {% endif %}
    var data = [];
    var devices = [];
    var yMaxs = {{ maximums }};
    var steps = [];

    for(i = 0;i < yMaxs.length;i++) {
        steps[i] = Math.ceil(yMaxs[i] / 10);
    }

    {% for device in devices %}
        devices.push("{{ device }}");
        data.push([]);
    {% endfor %}

    var mode = 'Live Stats';
    var months = ['January', 'February', 'March',
        'April', 'May', 'June',
        'July', 'August', 'September',
        'October', 'November', 'December'];
    var temperature = [];
    var totalPoints = 180; //The total memory is 180 sec (3 min)
    var updateInterval = 1000; // 200 x 1000 = 200sec (3min)
    var now = new Date().getTime() - totalPoints * updateInterval; //200 x 1000
    var counter = 1;

    function getValue(value){
        switch ('{{ metric_to_display }}'){
            case "voltage":
                return value.voltage;
            case "power":
                return value.power;
            case "temperature":
                return value.temperature;
        }
    }

    var i = 0;

    {% for device in devices %}
        {% if measurements[device]|length > 1 %}
            data[{{ loop.index }} - 1] = {{ measurements[device] }};
        {% endif %}
    {% endfor %}

    for (var j = 0; j < totalPoints; j++) {
        for (i = 0; i < data.length; i++) {
            if(data[i].length > j) {
                data[i][j][0] = now;
            }
        }
        now += updateInterval;
    }

    function GenerateFakeData(input) {
        input.shift();
        var timestamp = input[input.length - 1][0] + updateInterval;
        var prev = input[input.length - 1][1];

        var deviation = (Math.random() - 0.5) * 5;
        var val = prev + deviation;

        input.push([timestamp, val]);
    };

    function GetData() {
        $.ajax({
            url: "/api/data/user/measurement/" + totalPoints,
            dataType: "json",
            async: false,
            success: function (values, textStatus) {
                console.log(values);
                var value;

                for(var j =0;j < devices.length;j++) {
                    var nowTmp = now;
                    var device_id = devices[j];

                    if (data[j].length < totalPoints) {
                        data[j] = [];
                        var delta = totalPoints - data[j].length;

                        for (var i = values[device_id].length - delta; i < values[device_id].length; i++) {
                            value = getValue(values[device_id][i]);
                            nowTmp += updateInterval;
                            data[j].push([nowTmp, value]);
                        }
                    } else {
                        var prev = data[j][data[j].length - 1][0];
                        var lastIndex = values[device_id].length - 1;

                        value = getValue(values[device_id][lastIndex]);
                        data[j].shift();
                        var newValue = [prev + updateInterval, value];
                        data[j].push(newValue);
                    }
                }
            },
            error: function (value, textStatus) {
                console.log("Error")
            }
        });
    }

    var options = [];
    function initOptions() {
        var tick;
        //tick = [0.03 * updateInterval, "second"];
        //if (mode == 'Week')
        tick: [2, "day"];

        for(var i = 0;i < devices.length;i++) {
            options[i] = {
                series: {
                    lines: {
                        show: true,
                        lineWidth: 2,
                        fill: true,
                        fillColor: {colors: [{opacity: 0.4}, {opacity: 0}]},
                    }
                },
                xaxis: {
                    mode: "time",
                    //tickSize: [30, "second"],
                    //tickSize: [totalPoints/10, "second"],
                    //tickSize: [0.03 * updateInterval, "second"],
                    tickSize: tick,

                    tickFormatter: function (v, axis) {
                        var date = new Date(v);
                        //if (date.getSeconds() % 60 == 0) {
                        //if (date.getSeconds() % totalPoints/10 == 0) {
                        if (date.getSeconds() % 0.06 * updateInterval == 0) {
                            var month = months[date.getUTCMonth() + 1]; //months from 1-12
                            var day = date.getUTCDate();
                            var newdate = month + "/" + day;

                            var hours = date.getHours() < 10 ? "0" + date.getHours() : date.getHours();
                            var minutes = date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes();
                            var seconds = date.getSeconds() < 10 ? "0" + date.getSeconds() : date.getSeconds();
                            if (mode == 'Week')
                                return newdate + ", " + hours + ":" + minutes;
                            return hours + ":" + minutes + ":" + seconds;
                        }
                        else {
                            return "";
                        }
                    },
                    axisLabel: "Time",
                    axisLabelUseCanvas: true,
                    axisLabelFontSizePixels: 12,
                    axisLabelFontFamily: 'Verdana, Arial',
                    axisLabelPadding: 10
                },
                yaxis: {
                    min: 0,
                    max: yMaxs[i],
                    tickSize: steps[i],
                    tickFormatter: function (v, axis) {
                        return v + " {{ unit }}";
                    },
                    axisLabel: "{{ metric_to_display }}",
                    axisLabelUseCanvas: true,
                    axisLabelFontSizePixels: 12,
                    axisLabelFontFamily: 'Verdana, Arial',
                    axisLabelPadding: 6
                },
                legend: {
                    labelBoxBorderColor: "#fff"
                },
                grid: {
                    //backgroundColor: "#000000",
                    backgroundColor: "#fff",
                    //tickColor: "#008040"
                    borderWidth: 1,
                    hoverable: true, clickable: true, autoHighlight: true
                }
            };
        }
    }

    $(document).ready(function () {
        dataset = [];
        GetData();

        for (i = 0; i < devices.length; i++) {
            dataset.push([
                //{ label: "CPU", data: data, color: "#00FF00" }
                {data: data[i], label: '{{ metric_to_display }}', color: 'green', points: {show: false}},
                //{ data: temperature, label: 'Temperature', color: '#ed7a53' , points: { show: false }}
            ])
        }
        initOptions();

        for (i = 0; i < devices.length; i++) {
            $.plot($("#flot-placeholder" + devices[i]), dataset[i], options[i]);
        }
        console.log('totalPoints * updateInterval: ', totalPoints * updateInterval);

        for (i = 0; i < devices.length; i++) {
            $("#flot-placeholder" + devices[i]).bind("plothover", function (event, pos, item) {

                /*  Tooltips  */

                /* 1. Adding tooltip */
                $("<div id='tooltip'></div>").css({
                    position: "absolute",
                    display: "none",
                    border: "1px solid #fdd",
                    padding: "2px",
                    //"background-color": "#fee",
                    "background-color": " #fff59d ",
                    opacity: 0.80
                }).appendTo("body");

                /* 2. Put data in tooltip */
                if (item) {
                    //console.log('item: ', item.datapoint[1]);
                    var dateTip = new Date(item.datapoint[0]);

                    function pad(n) {
                        return n < 10 ? '0' + n : n
                    } // for adding leading zeros
                    dateTip = pad(dateTip.getHours()) + ":" + pad(dateTip.getMinutes()) + ":" + pad(dateTip.getSeconds());
                    if (mode == 'Week')
                        dateTip = pad(dateTip.getHours()) + ":" + pad(dateTip.getMinutes()) + ":" + pad(dateTip.getSeconds());
                    $("#tooltip").html("<b>" + Math.floor(item.datapoint[1]) + " {{ unit }} </b> <br>" + " <small>" + dateTip + " </small>")
                            .css({top: item.pageY - 65, left: item.pageX - 10})
                            .fadeIn(200);
                }
                else {
                    $("#tooltip").hide();
                }
            });
        }

        var timerId= 0;

        function update() {
            console.log("update! ");
            now = new Date().getTime();

            for (var i = 0; i < devices.length; i++) {
                if(!data[i]) {
                    data.push([]);
                    dataset[i] = [
                        //{ label: "CPU", data: data, color: "#00FF00" }
                        {data: data[i], label: '{{ metric_to_display }}', color: 'green', points: {show: false}},
                        //{ data: temperature, label: 'Temperature', color: '#ed7a53' , points: { show: false }}
                    ]
                }

                if(counter != 0) {
                    GenerateFakeData(data[i]);
                }
            }

            if(counter == 0) {
                GetData();
            }

            for(i = 0;i < devices.length;i++){
                $.plot($("#flot-placeholder" + devices[i]), dataset[i], options[i]);
            }

            timerId = setTimeout(update, updateInterval);
            counter = (counter + 1) % 10;
        }

        update();

        /* Manage tabs events*/
        var anchor;
        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {

            // Read the a text of the anchor that was clicked
            mode = $(e.target).context.innerText;

            console.log("text: ", mode)
            console.log("old updateInterval: ", updateInterval)

            /* Change update interval */
            switch (mode) {
                case 'Live Stats':
                    updateInterval = 1000;             //1 sec  / 3 minutes
                    break;
                case 'Hour':
                    updateInterval = 20 * 1000;       //20 sec  / 1 hour
                    break;
                case 'Day':
                    updateInterval = 24 * 20 * 1000;   //8 min   / 24 hours
                    break;
                case 'Week':
                    updateInterval = 7 * 24 * 20 * 1000; //56 min / 7 days
                    break;
                default:
                    alert('Я таких значений не знаю')
            }
            console.log("updateInterval: ", updateInterval);

            /* drop the data[] and run update */
            data = [];
            now = new Date().getTime() - totalPoints * updateInterval; //200 x 1000

            initOptions();

            for (var i = 0; i < devices.length; i++) {
                if(!data[i]) {
                    data.push([]);
                    dataset[i] = [
                        //{ label: "CPU", data: data, color: "#00FF00" }
                        {data: data[i], label: '{{ metric_to_display }}', color: 'green', points: {show: false}},
                        //{ data: temperature, label: 'Temperature', color: '#ed7a53' , points: { show: false }}
                    ]
                }

                $.plot($("#flot-placeholder" + devices[i]), dataset[i], options[i]);
            }

            GetData();

            console.log('totalPoints * updateInterval: ', totalPoints * updateInterval)
            clearTimeout(timerId);
            update();
        });

    });
</script>